<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orphaned Resource Hunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1024px;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 bg-white rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Orphaned Resource Hunter</h1>
            <div class="flex items-center space-x-2">
                <button id="refresh-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors duration-200">
                    Refresh
                </button>
            </div>
        </div>

        <div id="message-container" class="mb-4"></div>

        <div id="loading-spinner" class="hidden flex justify-center items-center py-8">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.001 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-600 font-medium">Scanning for orphaned resources...</span>
        </div>

        <div id="resources-container">
            <!-- Resource cards will be injected here -->
        </div>

        <div id="no-resources-found" class="hidden text-center py-10 text-gray-500 font-medium text-lg">
            No orphaned resources found.
        </div>
    </div>

    <script>
        // API Gateway URLs verified to be working
        const SCANNER_URL = "https://fee8bpnpoh.execute-api.eu-north-1.amazonaws.com/prod/scanner";
        const DELETER_URL = "https://fee8bpnpoh.execute-api.eu-north-1.amazonaws.com/prod/delete";

        const refreshButton = document.getElementById('refresh-btn');
        const resourcesContainer = document.getElementById('resources-container');
        const messageContainer = document.getElementById('message-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noResourcesMessage = document.getElementById('no-resources-found');

        // Function to show and hide messages in a user-friendly way
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg font-medium text-sm transition-opacity duration-300 ${
                type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'
            }`;
            messageDiv.textContent = message;
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageDiv);
        }

        // Main function to fetch and display resources from the API
        async function fetchResources() {
            loadingSpinner.classList.remove('hidden');
            resourcesContainer.innerHTML = '';
            noResourcesMessage.classList.add('hidden');
            messageContainer.innerHTML = '';
            refreshButton.disabled = true;

            try {
                const response = await fetch(SCANNER_URL);
                const data = await response.json();
                
                loadingSpinner.classList.add('hidden');
                refreshButton.disabled = false;

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch resources.');
                }
                
                // The single, correct line to access the resources array from the "items" key
                const items = data.items || [];

                // Log the raw data and the items array to the console for debugging
                console.log('API Raw Data:', data);
                console.log('Orphaned Resources:', items);

                if (items.length === 0) {
                    noResourcesMessage.classList.remove('hidden');
                } else {
                    items.forEach(item => {
                        const card = createResourceCard(item);
                        resourcesContainer.appendChild(card);
                    });
                }
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                refreshButton.disabled = false;
                console.error('Error fetching resources:', error);
                showMessage('Failed to fetch resources. Please check your API URL and Lambda logs.', 'error');
            }
        }

        // Function to create a resource card for the UI
        function createResourceCard(item) {
            // Using a fallback for key names to be more resilient to changes
            const resourceId = item.ResourceId || item.id;
            const resourceType = item.ResourceType || item.type;
            const foundAt = new Date(item.FoundAt || item.timestamp).toLocaleString();

            const card = document.createElement('div');
            card.id = `card-${resourceId}`;
            card.className = "bg-white p-6 rounded-lg shadow-md mb-4 flex justify-between items-center";
            
            // Check if the resource is an EBS Snapshot to disable deletion
            let buttonHtml = '';
            if (resourceType === 'EBS Snapshot') {
                buttonHtml = `
                    <div class="bg-yellow-100 text-yellow-800 text-sm font-medium px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        Attached to an AMI
                    </div>
                `;
            } else {
                buttonHtml = `
                    <button class="delete-btn bg-red-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-red-600 transition-colors duration-200"
                            data-id="${resourceId}" data-type="${resourceType}">
                        Delete
                    </button>
                `;
            }
            
            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${resourceType}</h3>
                    <p class="text-sm text-gray-500">ID: ${resourceId}</p>
                    <p class="text-xs text-gray-400">Found At: ${foundAt}</p>
                </div>
                <div>
                    ${buttonHtml}
                </div>
            `;

            const deleteButton = card.querySelector('.delete-btn');
            if (deleteButton) {
                deleteButton.addEventListener('click', () => {
                    deleteResource(resourceId, resourceType);
                });
            }
            
            return card;
        }

        // Function to delete a resource via the API
        async function deleteResource(resourceId, resourceType) {
            // Use a custom modal instead of alert()
            if (!confirm(`Are you sure you want to delete the ${resourceType} with ID: ${resourceId}?`)) {
                return;
            }

            const card = document.getElementById(`card-${resourceId}`);
            if (card) {
                card.classList.add('opacity-50', 'pointer-events-none');
            }

            try {
                const response = await fetch(DELETER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        resource_id: resourceId,
                        resource_type: resourceType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete resource.');
                }

                showMessage(data.message || 'Resource deleted successfully.', 'success');
                if (card) {
                    card.remove();
                }
                if (resourcesContainer.children.length === 0) {
                     noResourcesMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error deleting resource:', error);
                showMessage(`Error: ${error.message}`, 'error');
                if (card) {
                    card.classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }
        
        // Event listener for the refresh button
        refreshButton.addEventListener('click', fetchResources);

        // Run fetchResources on page load
        fetchResources();

    </script>
</body>
</html>
